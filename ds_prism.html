<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title></title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/flatly.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>
<style type="text/css">
/* padding for bootstrap navbar */
body {
padding-top: 50px;
padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar) */
.section h2 {
padding-top: 55px;
margin-top: -55px;
}
.section h3 {
padding-top: 55px;
margin-top: -55px;
}
/* don't use link color in navbar */
.dropdown-menu>li>a {
color: black;
}
/* some padding for disqus */
#disqus_thread {
margin-top: 45px;
}
</style>
<link rel="stylesheet" href="libs/font-awesome-4.1.0/css/font-awesome.min.css"/>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #303030; color: #cccccc; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; }
td.sourceCode { padding-left: 5px; }
pre, code { color: #cccccc; background-color: #303030; }
code > span.kw { color: #f0dfaf; }
code > span.dt { color: #dfdfbf; }
code > span.dv { color: #dcdccc; }
code > span.bn { color: #dca3a3; }
code > span.fl { color: #c0bed1; }
code > span.ch { color: #dca3a3; }
code > span.st { color: #cc9393; }
code > span.co { color: #7f9f7f; }
code > span.ot { color: #efef8f; }
code > span.al { color: #ffcfaf; }
code > span.fu { color: #efef8f; }
code > span.er { color: #c3bf9f; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46129458-3', 'auto');
  ga('send', 'pageview');

</script>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<div class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Downscaling</a>
      </div>
      <div class="navbar-collapse collapse navbar-responsive-collapse">
        <ul class="nav navbar-nav">
          <li><a href="index.html">Overview</a></li>

          <li class="dropdown">
            <a href="climatologies" class="dropdown-toggle" data-toggle="dropdown">Climatologies <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Main script</li>
              <li><a href="climatologies.html">climatologies.R</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Functions</li>
              <li><a href="climPrep.html">climPrep.R</a></li>
              <li><a href="climCalc.html">climCalc.R</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">CRU 2.0</li>
              <li><a href="cru20prelimExtraction">cru20prelimExtraction.R</a></li>
            </ul>

          <li class="dropdown">
            <a href="anomalies" class="dropdown-toggle" data-toggle="dropdown">Anomalies <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Main script</li>
              <li><a href="anomalies.html">anomalies.R</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Functions</li>
              <li><a href="anomPrep.html">anomPrep.R</a></li>
              <li><a href="anomCalc.html">anomCalc.R</a></li>
              <li><a href="anomCalcAsScript.html">anomCalcAsScript.R</a></li>
              <li><a href="anomParSubFunc.html">anomParSubFunc.R</a></li>
            </ul>

          <li class="dropdown">
            <a href="downscaling" class="dropdown-toggle" data-toggle="dropdown">Downscaling <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">2-km/771-m PRISM</li>
              <li><a href="ds_prism.html">ds_prism.R</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">10-minute CRU 2.0</li>
              <li><a href="ds_world10min.html">ds_world10min.R</a></li>
            </ul>

          <li><a href="http://leonawicz.github.io">All Projects</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <a class="btn btn-link" href="https://github.com/leonawicz/Downscaling">
            <i class="fa fa-github fa-lg"></i>
            Github
          </a>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>



<div id="section" class="section level2">
<h2></h2>
</div>
<div id="section-1" class="section level2">
<h2></h2>
</div>
<div id="ds_prism.r" class="section level2">
<h2>ds_prism.R</h2>
<p>This script downscales monthly climate anomalies geotiffs to either of two sets of monthly PRISM climatologies, the 2-km resolution 1961-1990 climatologies or the 771-m 1971-2000 climatologies.</p>
<p>Unlike the <code>climatologies.R</code> and <code>amomalies.R</code> which create their respective geotiffs for any of a number of different data sets, this downscaling script strictly performs downscaling to these PRISM climatologies over their respective spatial extents at the respective resolutions.</p>
<p>Although the PRISM downscaling code below includes a <code>method</code> argument, which bifurcates the processing function into two methods of downscaling, only one method is functional when attempting to downscale such a large amount of data to such a fine spatial resolution at once using parallelized code.</p>
<p>Using <code>method='gdal'</code> will tend to throw segmentation fault errors related to GDAL dataset copy failures on the Atlas cluster. As a result, the tried and true <code>method='akima'</code> must be used. The former approach is successfully used in the 10-minute resolution CRU 2.0 climatology downscaling, where GDAL does not choke on the smaller amount of data. The upside to this method, although slower even when functional, is that it allows for more familiar-looking code, in the sense that more people working with spatial data are familiar with the <code>raster</code> package, which handles the transformations, as opposed to the <code>akima</code> package.</p>
<p>At this scale, however, <code>method='akima'</code> must be used, unless one wants to wait forever for serial processing of so many files using the <code>raster</code> package. Therefore, the methods used in this version of downscaling are not the same as those employed when downscaling to some coarser climatologies.</p>
<p><code>ds_prism.R</code> is called with command line arguments by one of two SLURM scripts, <code>ds_prism_cru.slurm</code> or <code>ds_prism_gcm.slurm</code>.</p>
<div id="r-code" class="section level3">
<h3>R code</h3>
<div id="setup" class="section level4">
<h4>Setup</h4>
<pre class="sourceCode r"><code class="sourceCode r">comargs &lt;-<span class="st"> </span>(<span class="kw">commandArgs</span>(<span class="ot">TRUE</span>))
if (!<span class="kw">length</span>(comargs)) <span class="kw">q</span>(<span class="st">&quot;no&quot;</span>) else for (z in <span class="dv">1</span>:<span class="kw">length</span>(comargs)) <span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> comargs[[z]]))

if (!<span class="kw">exists</span>(<span class="st">&quot;i&quot;</span>)) <span class="kw">stop</span>(<span class="st">&quot;Index variable &#39;i&#39; not passed at command line.&quot;</span>)
if (!<span class="kw">exists</span>(<span class="st">&quot;domain&quot;</span>)) <span class="kw">stop</span>(<span class="st">&quot;Spatial domain variable &#39;domain&#39; not passed at command line.&quot;</span>)
if (!(domain %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;akcan2km&quot;</span>, <span class="st">&quot;ak771m&quot;</span>))) <span class="kw">stop</span>(<span class="st">&quot;Improper spatial domain specified.&quot;</span>)

<span class="kw">library</span>(raster)
<span class="kw">library</span>(parallel)

<span class="co"># Part of GDAL test rasterOptions(maxmemory=1e+10, chunksize=2e+08) # 12</span>
<span class="co"># simultaneous processes on one Atlas node</span>
<span class="co"># rasterOptions(tmpdir=&#39;/big_scratch/mfleonawicz/tmp/&#39;)</span>
<span class="co"># print(rasterOptions())</span>

if (domain ==<span class="st"> &quot;akcan2km&quot;</span>) climDir &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;/Data/Base_Data/Climate/AK_CAN_2km/historical/singleBand/prism/AK_CAN_2km_PRISM/AK_CAN_geotiffs/&quot;</span>, 
    <span class="kw">c</span>(<span class="st">&quot;pr&quot;</span>, <span class="st">&quot;tas&quot;</span>), <span class="st">&quot;/ak83albers&quot;</span>)
if (domain ==<span class="st"> &quot;ak771m&quot;</span>) climDir &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;/Data/Base_Data/Climate/AK_800m/historical/singleBand/prism/AK_800m_PRISM/geotiffs/&quot;</span>, 
    <span class="kw">c</span>(<span class="st">&quot;pr&quot;</span>, <span class="st">&quot;tas&quot;</span>))
b.clim.p &lt;-<span class="st"> </span><span class="kw">readAll</span>(<span class="kw">stack</span>(<span class="kw">list.files</span>(climDir[<span class="dv">1</span>], <span class="dt">full =</span> <span class="ot">TRUE</span>, <span class="dt">pattern =</span> <span class="st">&quot;.tif$&quot;</span>)))
b.clim.t &lt;-<span class="st"> </span><span class="kw">readAll</span>(<span class="kw">stack</span>(<span class="kw">list.files</span>(climDir[<span class="dv">2</span>], <span class="dt">full =</span> <span class="ot">TRUE</span>, <span class="dt">pattern =</span> <span class="st">&quot;.tif$&quot;</span>)))

anomDir &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="st">&quot;/Data/Base_Data/Climate/World/Anomalies/1961_1990_Base_Climatology&quot;</span>, 
    <span class="dt">full =</span> T)
allowed.models &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;cccma-cgcm3-1-t47&quot;</span>, <span class="st">&quot;gfdl-cm2-1&quot;</span>, <span class="st">&quot;miroc3-2-medres&quot;</span>, <span class="st">&quot;mpi-echam5&quot;</span>, 
    <span class="st">&quot;ukmo-hadcm3&quot;</span>, <span class="st">&quot;CCSM4&quot;</span>, <span class="st">&quot;GFDL-CM3&quot;</span>, <span class="st">&quot;GISS-E2-R&quot;</span>, <span class="st">&quot;IPSL-CM5A-LR&quot;</span>, <span class="st">&quot;MRI-CGCM3&quot;</span>, 
    <span class="st">&quot;CRU_TS30&quot;</span>, <span class="st">&quot;CRU_TS31&quot;</span>, <span class="st">&quot;CRU_TS32&quot;</span>)

outDir &lt;-<span class="st"> </span>if (domain ==<span class="st"> &quot;akcan2km&quot;</span>) <span class="st">&quot;/Data/Base_Data/Climate/AK_CAN_2km&quot;</span> else <span class="st">&quot;/Data/Base_Data/Climate/AK_800m&quot;</span>

if (i &gt;<span class="st"> </span><span class="kw">length</span>(anomDir)) <span class="kw">stop</span>(<span class="st">&quot;Index variable &#39;i&#39; exceeds maximum value.&quot;</span>)

mos &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">paste0</span>(<span class="dv">0</span>, <span class="dv">1</span>:<span class="dv">9</span>), <span class="dv">10</span>:<span class="dv">12</span>)
meta &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">strsplit</span>(<span class="kw">basename</span>(anomDir[i]), <span class="st">&quot;_&quot;</span>))
grp &lt;-<span class="st"> </span>meta[<span class="dv">1</span>]
grp2 &lt;-<span class="st"> </span>if (grp ==<span class="st"> &quot;AR4&quot;</span>) <span class="st">&quot;AR4_CMIP3_models&quot;</span> else if (grp ==<span class="st"> &quot;AR5&quot;</span>) <span class="st">&quot;AR5_CMIP5_models&quot;</span> else grp
scenario &lt;-<span class="st"> </span>meta[<span class="dv">4</span>]
period.scenario &lt;-<span class="st"> </span>if (scenario ==<span class="st"> &quot;historical&quot;</span>) <span class="kw">c</span>(scenario, <span class="st">&quot;&quot;</span>) else <span class="kw">c</span>(<span class="st">&quot;projected&quot;</span>, 
    scenario)
<span class="co"># period.scenario &lt;- if(scenario==&#39;historical&#39;) c(file.path(scenario,</span>
<span class="co"># &#39;singleBand&#39;), &#39;&#39;) else c(&#39;projected&#39;, scenario)</span>
models &lt;-<span class="st"> </span><span class="kw">list.files</span>(anomDir[i])
models &lt;-<span class="st"> </span>models[models %in%<span class="st"> </span>allowed.models]</code></pre>
</div>
<div id="support-function" class="section level4">
<h4>Support function</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Support function for method=&#39;akima&#39;</span>
trim2 &lt;-<span class="st"> </span>function(x, <span class="dt">y =</span> <span class="ot">NULL</span>, <span class="dt">out =</span> <span class="st">&quot;matrix&quot;</span>, <span class="dt">rc.ind =</span> F, <span class="dt">xy.ext =</span> F) {
    if (!<span class="kw">any</span>(out ==<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;matrix&quot;</span>, <span class="st">&quot;raster&quot;</span>))) 
        <span class="kw">stop</span>(<span class="st">&quot;output must be a matrix or raster&quot;</span>)
    if (<span class="kw">class</span>(x) ==<span class="st"> &quot;matrix&quot;</span>) {
        if (<span class="kw">class</span>(y) !=<span class="st"> &quot;RasterLayer&quot;</span> &amp;<span class="st"> </span>(out ==<span class="st"> &quot;raster&quot;</span> |<span class="st"> </span>xy.ext ==<span class="st"> </span>T)) 
            <span class="kw">stop</span>(<span class="st">&quot;must input spatial information for raster or extent outputs&quot;</span>)
        if (out ==<span class="st"> &quot;raster&quot;</span> |<span class="st"> </span>xy.ext ==<span class="st"> </span>T) {
            cres &lt;-<span class="st"> </span><span class="fl">0.5</span> *<span class="st"> </span><span class="kw">res</span>(y)
            crs &lt;-<span class="st"> </span><span class="kw">projection</span>(y)
        }
    }
    if (<span class="kw">class</span>(x) ==<span class="st"> &quot;RasterLayer&quot;</span>) {
        if (out ==<span class="st"> &quot;raster&quot;</span> |<span class="st"> </span>xy.ext ==<span class="st"> </span>T) {
            cres &lt;-<span class="st"> </span><span class="fl">0.5</span> *<span class="st"> </span><span class="kw">res</span>(x)
            crs &lt;-<span class="st"> </span><span class="kw">projection</span>(x)
            y &lt;-<span class="st"> </span>x
        }
        x &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">as.array</span>(x), <span class="dt">nrow =</span> <span class="kw">nrow</span>(x), <span class="dt">ncol =</span> <span class="kw">ncol</span>(x))
    }
    if (<span class="kw">class</span>(x) !=<span class="st"> &quot;matrix&quot;</span>) {
        <span class="kw">stop</span>(<span class="st">&quot;x must be of class raster or matrix&quot;</span>)
    } else {
        r.na &lt;-<span class="st"> </span>c.na &lt;-<span class="st"> </span><span class="kw">c</span>()
        for (i in <span class="dv">1</span>:<span class="kw">nrow</span>(x)) r.na &lt;-<span class="st"> </span><span class="kw">c</span>(r.na, <span class="kw">all</span>(<span class="kw">is.na</span>(x[i, ])))
        for (i in <span class="dv">1</span>:<span class="kw">ncol</span>(x)) c.na &lt;-<span class="st"> </span><span class="kw">c</span>(c.na, <span class="kw">all</span>(<span class="kw">is.na</span>(x[, i])))
        r1 &lt;-<span class="st"> </span><span class="dv">1</span> +<span class="st"> </span><span class="kw">which</span>(<span class="kw">diff</span>(<span class="kw">which</span>(r.na)) &gt;<span class="st"> </span><span class="dv">1</span>)[<span class="dv">1</span>]
        r2 &lt;-<span class="st"> </span><span class="kw">nrow</span>(x) -<span class="st"> </span><span class="kw">which</span>(<span class="kw">diff</span>(<span class="kw">which</span>(<span class="kw">rev</span>(r.na))) &gt;<span class="st"> </span><span class="dv">1</span>)[<span class="dv">1</span>]
        c1 &lt;-<span class="st"> </span><span class="dv">1</span> +<span class="st"> </span><span class="kw">which</span>(<span class="kw">diff</span>(<span class="kw">which</span>(c.na)) &gt;<span class="st"> </span><span class="dv">1</span>)[<span class="dv">1</span>]
        c2 &lt;-<span class="st"> </span><span class="kw">ncol</span>(x) -<span class="st"> </span><span class="kw">which</span>(<span class="kw">diff</span>(<span class="kw">which</span>(<span class="kw">rev</span>(c.na))) &gt;<span class="st"> </span><span class="dv">1</span>)[<span class="dv">1</span>]
        x &lt;-<span class="st"> </span>x[r1:r2, c1:c2]
        if (out ==<span class="st"> &quot;raster&quot;</span> |<span class="st"> </span>xy.ext ==<span class="st"> </span>T) {
            xs &lt;-<span class="st"> </span><span class="kw">xFromCol</span>(y, <span class="dt">col =</span> <span class="kw">c</span>(c1, c2)) +<span class="st"> </span><span class="kw">c</span>(-<span class="dv">1</span>, <span class="dv">1</span>) *<span class="st"> </span>cres[<span class="dv">1</span>]
            ys &lt;-<span class="st"> </span><span class="kw">yFromRow</span>(y, <span class="dt">row =</span> <span class="kw">c</span>(r2, r1)) +<span class="st"> </span><span class="kw">c</span>(-<span class="dv">1</span>, <span class="dv">1</span>) *<span class="st"> </span>cres[<span class="dv">2</span>]
        }
        if (out ==<span class="st"> &quot;raster&quot;</span>) 
            x &lt;-<span class="st"> </span><span class="kw">raster</span>(x, <span class="dt">xmn =</span> xs[<span class="dv">1</span>], <span class="dt">xmx =</span> xs[<span class="dv">2</span>], <span class="dt">ymn =</span> ys[<span class="dv">1</span>], <span class="dt">ymx =</span> ys[<span class="dv">2</span>], 
                <span class="dt">crs =</span> crs)
        if (rc.ind ==<span class="st"> </span>T &amp;<span class="st"> </span>xy.ext ==<span class="st"> </span>T) {
            x &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">x =</span> x, <span class="dt">rc =</span> <span class="kw">c</span>(r1, r2, c1, c2), <span class="dt">xy =</span> <span class="kw">c</span>(xs, ys))
        } else if (rc.ind) {
            x &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">x =</span> x, <span class="dt">rc =</span> <span class="kw">c</span>(r1, r2, c1, c2))
        } else if (xy.ext) {
            x &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">x =</span> x, <span class="dt">xy =</span> <span class="kw">c</span>(xs, ys))
        }
    }
    <span class="kw">return</span>(x)
}</code></pre>
</div>
<div id="processing-function" class="section level4">
<h4>Processing function</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Processing function</span>
f &lt;-<span class="st"> </span>function(j, i, <span class="dt">par.by.month =</span> <span class="ot">FALSE</span>, anomDir, outDir, b.clim.t, b.clim.p, 
    <span class="dt">method =</span> <span class="st">&quot;akima&quot;</span>) {
    if (par.by.month) {
        mo &lt;-<span class="st"> </span>j
        jj &lt;-<span class="st"> </span>j &lt;-<span class="st"> </span><span class="dv">1</span>
    } else {
        mo &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="dv">12</span>
        jj &lt;-<span class="st"> </span><span class="kw">length</span>(models)
    }
    for (k in mo) {
        r.clim.t &lt;-<span class="st"> </span><span class="kw">subset</span>(b.clim.t, k)
        r.clim.p &lt;-<span class="st"> </span><span class="kw">subset</span>(b.clim.p, k)
        <span class="co"># Read temp and precip (two) annual time series multiband tif files for</span>
        <span class="co"># given anomalies directory, model, and month</span>
        pat.t &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;^tas.*._&quot;</span>, mos[k], <span class="st">&quot;_.*.tif$&quot;</span>)
        pat.p &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;^pr.*._&quot;</span>, mos[k], <span class="st">&quot;_.*.tif$&quot;</span>)
        file.t &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="kw">file.path</span>(anomDir[i], models[j]), <span class="dt">pattern =</span> pat.t, 
            <span class="dt">full =</span> T)
        file.p &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="kw">file.path</span>(anomDir[i], models[j]), <span class="dt">pattern =</span> pat.p, 
            <span class="dt">full =</span> T)
        isCRU &lt;-<span class="st"> </span><span class="kw">substr</span>(models[j], <span class="dv">1</span>, <span class="dv">3</span>) ==<span class="st"> &quot;CRU&quot;</span>
        file.year.ind &lt;-<span class="st"> </span>if (isCRU) 
            <span class="dv">7</span>:<span class="dv">8</span> else <span class="dv">9</span>:<span class="dv">10</span>
        yrs &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">substr</span>(<span class="kw">unlist</span>(<span class="kw">strsplit</span>(<span class="kw">basename</span>(file.t), <span class="st">&quot;_&quot;</span>))[file.year.ind], 
            <span class="dv">1</span>, <span class="dv">4</span>))
        yrs &lt;-<span class="st"> </span><span class="kw">seq</span>(yrs[<span class="dv">1</span>], yrs[<span class="dv">2</span>])
        <span class="kw">dir.create</span>(outDir.t &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;//&quot;</span>, <span class="st">&quot;/&quot;</span>, <span class="kw">file.path</span>(outDir, period.scenario[<span class="dv">1</span>], 
            grp2, period.scenario[<span class="dv">2</span>], models[j], <span class="st">&quot;tas&quot;</span>)), <span class="dt">recur =</span> T, <span class="dt">showWarnings =</span> F)
        <span class="kw">dir.create</span>(outDir.p &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;//&quot;</span>, <span class="st">&quot;/&quot;</span>, <span class="kw">file.path</span>(outDir, period.scenario[<span class="dv">1</span>], 
            grp2, period.scenario[<span class="dv">2</span>], models[j], <span class="st">&quot;pr&quot;</span>)), <span class="dt">recur =</span> T, <span class="dt">showWarnings =</span> F)
        
        b.anom.t &lt;-<span class="st"> </span><span class="kw">brick</span>(file.t)
        b.anom.p &lt;-<span class="st"> </span><span class="kw">brick</span>(file.p)
        if (<span class="kw">xmin</span>(b.anom.t) &lt;<span class="st"> </span><span class="dv">0</span> &amp;<span class="st"> </span><span class="kw">xmax</span>(b.anom.t) &lt;<span class="st"> </span><span class="dv">360</span>) 
            b.anom.t &lt;-<span class="st"> </span><span class="kw">extend</span>(b.anom.t, <span class="kw">c</span>(<span class="kw">xmin</span>(b.anom.t), <span class="kw">xmax</span>(b.anom.t) +<span class="st"> </span>
<span class="st">                </span><span class="kw">res</span>(b.anom.t)[<span class="dv">1</span>], <span class="kw">ymin</span>(b.anom.t), <span class="kw">ymax</span>(b.anom.t)))  <span class="co"># slight adjustments for some files to avoid erroneous regions of NAs following interpolation</span>
        if (<span class="kw">xmin</span>(b.anom.t) &gt;<span class="st"> </span><span class="dv">0</span> |<span class="st"> </span><span class="kw">xmax</span>(b.anom.t) &lt;<span class="st"> </span><span class="dv">360</span>) 
            <span class="kw">stop</span>(<span class="st">&quot;Source raster brick files require direct investigation of extent values.&quot;</span>)
        if (<span class="kw">xmin</span>(b.anom.p) &lt;<span class="st"> </span><span class="dv">0</span> &amp;<span class="st"> </span><span class="kw">xmax</span>(b.anom.p) &lt;<span class="st"> </span><span class="dv">360</span>) 
            b.anom.p &lt;-<span class="st"> </span><span class="kw">extend</span>(b.anom.p, <span class="kw">c</span>(<span class="kw">xmin</span>(b.anom.p), <span class="kw">xmax</span>(b.anom.p) +<span class="st"> </span>
<span class="st">                </span><span class="kw">res</span>(b.anom.p)[<span class="dv">1</span>], <span class="kw">ymin</span>(b.anom.p), <span class="kw">ymax</span>(b.anom.p)))  <span class="co"># slight adjustments for some files to avoid erroneous regions of NAs following interpolation</span>
        if (<span class="kw">xmin</span>(b.anom.p) &gt;<span class="st"> </span><span class="dv">0</span> |<span class="st"> </span><span class="kw">xmax</span>(b.anom.p) &lt;<span class="st"> </span><span class="dv">360</span>) 
            <span class="kw">stop</span>(<span class="st">&quot;Source raster brick files require direct investigation of extent values.&quot;</span>)
        ext &lt;-<span class="st"> </span><span class="kw">extent</span>(<span class="kw">c</span>(<span class="kw">xmin</span>(b.anom.t), <span class="kw">xmax</span>(b.anom.t), <span class="dv">45</span>, <span class="dv">76</span>))  <span class="co"># Bigger than PRISM WGS84 bounding box by at least half a degree on all sides</span>
        nc &lt;-<span class="st"> </span><span class="kw">ncol</span>(b.anom.t)
        if (<span class="kw">xmin</span>(b.anom.t) &lt;<span class="st"> </span><span class="dv">0</span> &amp;<span class="st"> </span><span class="kw">all</span>(<span class="kw">is.na</span>(b.anom.t[nc]))) {
            for (h in <span class="dv">1</span>:<span class="kw">nlayers</span>(b.anom.t)) {
                r.anom.t &lt;-<span class="st"> </span><span class="kw">subset</span>(b.anom.t, h)
                r.anom.p &lt;-<span class="st"> </span><span class="kw">subset</span>(b.anom.p, h)
                r.anom.t[, nc] &lt;-<span class="st"> </span>r.anom.t[, <span class="dv">1</span>]  <span class="co"># Last row is the same as first row</span>
                r.anom.p[, nc] &lt;-<span class="st"> </span>r.anom.p[, <span class="dv">1</span>]
                b.anom.t &lt;-<span class="st"> </span><span class="kw">setValues</span>(b.anom.t, r.anom.t[], <span class="dt">layer =</span> h)
                b.anom.p &lt;-<span class="st"> </span><span class="kw">setValues</span>(b.anom.p, r.anom.p[], <span class="dt">layer =</span> h)
                <span class="kw">print</span>(h)
            }
        }
        b.anom.t &lt;-<span class="st"> </span><span class="kw">rotate</span>(<span class="kw">crop</span>(b.anom.t, ext))
        b.anom.p &lt;-<span class="st"> </span><span class="kw">rotate</span>(<span class="kw">crop</span>(b.anom.p, ext))
        <span class="kw">projection</span>(b.anom.t) &lt;-<span class="st"> </span><span class="kw">projection</span>(b.anom.p) &lt;-<span class="st"> &quot;+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0&quot;</span>
        <span class="kw">gc</span>()
        <span class="kw">print</span>(<span class="st">&quot;Bricks loaded. Commence downscaling.&quot;</span>)
        
        if (method ==<span class="st"> &quot;akima&quot;</span>) {
            <span class="kw">require</span>(<span class="st">&quot;akima&quot;</span>)
            proj4.out &lt;-<span class="st"> </span><span class="kw">projection</span>(r.clim.p)
            nr &lt;-<span class="st"> </span><span class="kw">nrow</span>(r.clim.t)
            nc &lt;-<span class="st"> </span><span class="kw">ncol</span>(r.clim.t)
            cres &lt;-<span class="st"> </span><span class="fl">0.5</span> *<span class="st"> </span><span class="kw">res</span>(r.clim.t)
            xmn &lt;-<span class="st"> </span><span class="kw">xmin</span>(r.clim.t) +<span class="st"> </span>cres[<span class="dv">1</span>]
            xmx &lt;-<span class="st"> </span><span class="kw">xmax</span>(r.clim.t) -<span class="st"> </span>cres[<span class="dv">1</span>]
            ymn &lt;-<span class="st"> </span><span class="kw">ymin</span>(r.clim.t) +<span class="st"> </span>cres[<span class="dv">2</span>]
            ymx &lt;-<span class="st"> </span><span class="kw">ymax</span>(r.clim.t) -<span class="st"> </span>cres[<span class="dv">2</span>]
            x.out &lt;-<span class="st"> </span><span class="kw">seq</span>(xmn, xmx, <span class="dt">l =</span> nc)
            y.out &lt;-<span class="st"> </span><span class="kw">seq</span>(ymn, ymx, <span class="dt">l =</span> nr)
            m.clim.p &lt;-<span class="st"> </span><span class="kw">trim2</span>(r.clim.p, <span class="dt">rc.ind =</span> T, <span class="dt">xy.ext =</span> T)
            rc.ind &lt;-<span class="st"> </span>m.clim.p[[<span class="dv">2</span>]]
            xy.ext &lt;-<span class="st"> </span>m.clim.p[[<span class="dv">3</span>]]
            xmn &lt;-<span class="st"> </span>xy.ext[<span class="dv">1</span>]
            xmx &lt;-<span class="st"> </span>xy.ext[<span class="dv">2</span>]
            ymn &lt;-<span class="st"> </span>xy.ext[<span class="dv">3</span>]
            ymx &lt;-<span class="st"> </span>xy.ext[<span class="dv">4</span>]
            m.clim.p &lt;-<span class="st"> </span>m.clim.p[[<span class="dv">1</span>]]
            m.clim.t &lt;-<span class="st"> </span><span class="kw">trim2</span>(r.clim.t)
            
            for (h in <span class="dv">1</span>:<span class="kw">nlayers</span>(b.anom.t)) {
                r.anom.t &lt;-<span class="st"> </span><span class="kw">subset</span>(b.anom.t, h)
                r.anom.p &lt;-<span class="st"> </span><span class="kw">subset</span>(b.anom.p, h)
                v.t &lt;-<span class="st"> </span><span class="kw">getValues</span>(r.anom.t)
                v.p &lt;-<span class="st"> </span><span class="kw">getValues</span>(r.anom.p)
                if (h ==<span class="st"> </span><span class="dv">1</span>) {
                  xy &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">xyFromCell</span>(r.anom.p, <span class="dv">1</span>:<span class="kw">ncell</span>(r.anom.p)))
                  <span class="kw">coordinates</span>(xy) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>)
                  <span class="kw">proj4string</span>(xy) &lt;-<span class="st"> </span><span class="kw">projection</span>(r.anom.p)
                  xy &lt;-<span class="st"> </span><span class="kw">coordinates</span>(<span class="kw">spTransform</span>(xy, <span class="dt">CRS =</span> <span class="kw">CRS</span>(proj4.out)))
                  bb &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">bbox</span>(r.clim.t) *<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="fl">1.1</span>, <span class="fl">0.9</span>, <span class="fl">1.1</span>, 
                    <span class="fl">1.1</span>), <span class="dv">2</span>, <span class="dv">2</span>))
                  e &lt;-<span class="st"> </span><span class="dv">120000</span>  <span class="co"># extend all sides by 120 km</span>
                  ind1 &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">point.in.polygon</span>(xy[, <span class="dv">1</span>], xy[, <span class="dv">2</span>], <span class="kw">c</span>(xmn -<span class="st"> </span>e, 
                    xmx +<span class="st"> </span>e, xmx +<span class="st"> </span>e, xmn -<span class="st"> </span>e), <span class="kw">c</span>(ymn -<span class="st"> </span>e, ymn +<span class="st"> </span>e, ymx +<span class="st"> </span>e, 
                    ymx -<span class="st"> </span>e)) &gt;<span class="st"> </span><span class="dv">0</span>)
                }
                ind &lt;-<span class="st"> </span>ind1
                z.t &lt;-<span class="st"> </span>v.t[ind]
                z.p &lt;-<span class="st"> </span>v.p[ind]
                if (<span class="kw">any</span>(<span class="kw">is.na</span>(z.p))) 
                  ind &lt;-<span class="st"> </span>ind[!<span class="kw">is.na</span>(z.p)]
                x &lt;-<span class="st"> </span>xy[ind, <span class="dv">1</span>]
                y &lt;-<span class="st"> </span>xy[ind, <span class="dv">2</span>]
                z.t &lt;-<span class="st"> </span>v.t[ind]
                z.p &lt;-<span class="st"> </span>v.p[ind]
                spl.t &lt;-<span class="st"> </span><span class="kw">interp</span>(x, y, z.t, <span class="dt">xo =</span> x.out, <span class="dt">yo =</span> y.out, <span class="dt">linear =</span> T)
                spl.p &lt;-<span class="st"> </span><span class="kw">interp</span>(x, y, z.p, <span class="dt">xo =</span> x.out, <span class="dt">yo =</span> y.out, <span class="dt">linear =</span> T)
                mat.t &lt;-<span class="st"> </span><span class="kw">t</span>(spl.t$z)[nr:<span class="dv">1</span>, ]
                mat.p &lt;-<span class="st"> </span><span class="kw">t</span>(spl.p$z)[nr:<span class="dv">1</span>, ]
                if (<span class="kw">exists</span>(<span class="st">&quot;rc.ind&quot;</span>)) {
                  mat.t &lt;-<span class="st"> </span>mat.t[rc.ind[<span class="dv">1</span>]:rc.ind[<span class="dv">2</span>], rc.ind[<span class="dv">3</span>]:rc.ind[<span class="dv">4</span>]]
                  mat.p &lt;-<span class="st"> </span>mat.p[rc.ind[<span class="dv">1</span>]:rc.ind[<span class="dv">2</span>], rc.ind[<span class="dv">3</span>]:rc.ind[<span class="dv">4</span>]]
                }
                r.new.t &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="kw">round</span>(mat.t +<span class="st"> </span>m.clim.t, <span class="dv">1</span>), <span class="dt">xmn =</span> xmn, <span class="dt">xmx =</span> xmx, 
                  <span class="dt">ymn =</span> ymn, <span class="dt">ymx =</span> ymx, <span class="dt">crs =</span> proj4.out)
                r.new.p &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="kw">round</span>(mat.p *<span class="st"> </span>m.clim.p), <span class="dt">xmn =</span> xmn, <span class="dt">xmx =</span> xmx, 
                  <span class="dt">ymn =</span> ymn, <span class="dt">ymx =</span> ymx, <span class="dt">crs =</span> proj4.out)
                <span class="kw">names</span>(r.new.t) &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;tas_mean_C&quot;</span>, grp, models[j], scenario, 
                  mos[k], yrs[h], <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)
                <span class="kw">names</span>(r.new.p) &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;pr_total_mm&quot;</span>, grp, models[j], scenario, 
                  mos[k], yrs[h], <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)
                if (isCRU) {
                  <span class="kw">names</span>(r.new.t) &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;CRU_CRU_&quot;</span>, <span class="st">&quot;CRU_&quot;</span>, <span class="kw">names</span>(r.new.t))
                  <span class="kw">names</span>(r.new.p) &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;CRU_CRU_&quot;</span>, <span class="st">&quot;CRU_&quot;</span>, <span class="kw">names</span>(r.new.p))
                }
                <span class="kw">writeRaster</span>(r.new.t, <span class="kw">paste0</span>(outDir.t, <span class="st">&quot;/&quot;</span>, <span class="kw">names</span>(r.new.t), <span class="st">&quot;.tif&quot;</span>), 
                  <span class="dt">datatype =</span> <span class="st">&quot;FLT4S&quot;</span>, <span class="dt">options =</span> <span class="st">&quot;COMPRESS=LZW&quot;</span>, <span class="dt">overwrite =</span> T)
                <span class="kw">writeRaster</span>(r.new.p, <span class="kw">paste0</span>(outDir.p, <span class="st">&quot;/&quot;</span>, <span class="kw">names</span>(r.new.p), <span class="st">&quot;.tif&quot;</span>), 
                  <span class="dt">datatype =</span> <span class="st">&quot;FLT4S&quot;</span>, <span class="dt">options =</span> <span class="st">&quot;COMPRESS=LZW&quot;</span>, <span class="dt">overwrite =</span> T)
                <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;######## Model&quot;</span>, j, <span class="st">&quot;of&quot;</span>, jj, <span class="st">&quot;| Month&quot;</span>, k, <span class="st">&quot;of 12 | Year&quot;</span>, 
                  h, <span class="st">&quot;of&quot;</span>, <span class="kw">nlayers</span>(b.anom.t), <span class="st">&quot;########&quot;</span>))
            }
            
        } else if (method ==<span class="st"> &quot;gdal&quot;</span>) {
            <span class="co"># GDAL cannot process such a large chunk of data at once, use akima method</span>
            <span class="co"># for PRISM 2-km (or 771-m) downscaling</span>
            t.on &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()
            b.new.t &lt;-<span class="st"> </span><span class="kw">projectRaster</span>(b.anom.t, r.clim.t)
            <span class="kw">rm</span>(b.anom.t)
            <span class="kw">gc</span>()
            <span class="kw">print</span>(<span class="st">&quot;Brick projected&quot;</span>)
            b.new.t &lt;-<span class="st"> </span><span class="kw">mask</span>(b.new.t, r.clim.t)
            <span class="kw">gc</span>()
            <span class="kw">print</span>(<span class="st">&quot;Brick masked&quot;</span>)
            b.new.t &lt;-<span class="st"> </span><span class="kw">round</span>(b.new.t +<span class="st"> </span>r.clim.t, <span class="dv">1</span>)
            <span class="co"># assign(paste0(&#39;b.t.&#39;, k), b.new.t, pos=1) rm(b.new.t)</span>
            <span class="kw">gc</span>()
            <span class="kw">print</span>(<span class="st">&quot;Done with temperature downscaling&quot;</span>)
            t.off &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()
            <span class="kw">print</span>(<span class="kw">difftime</span>(t.off, t.on))
            t.on &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()
            
            <span class="co"># b.new.t &lt;- get(paste0(&#39;b.t.&#39;, k), envir=.GlobalEnv)</span>
            nc &lt;-<span class="st"> </span><span class="kw">ncol</span>(b.new.t)
            for (h in <span class="dv">1</span>:<span class="kw">nlayers</span>(b.new.t)) {
                <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;h =&quot;</span>, h))
                r.new.t &lt;-<span class="st"> </span><span class="kw">subset</span>(b.new.t, h)
                <span class="kw">print</span>(r.new.t)
                <span class="kw">names</span>(r.new.t) &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;tas_mean_C&quot;</span>, grp, models[j], scenario, 
                  mos[k], yrs[h], <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)
                if (isCRU) 
                  <span class="kw">names</span>(r.new.t) &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;CRU_CRU_&quot;</span>, <span class="st">&quot;CRU_&quot;</span>, <span class="kw">names</span>(r.new.t))
                <span class="kw">writeRaster</span>(r.new.t, <span class="kw">paste0</span>(outDir.t, <span class="st">&quot;/&quot;</span>, <span class="kw">names</span>(r.new.t), <span class="st">&quot;.tif&quot;</span>), 
                  <span class="dt">datatype =</span> <span class="st">&quot;FLT4S&quot;</span>, <span class="dt">options =</span> <span class="st">&quot;COMPRESS=LZW&quot;</span>, <span class="dt">overwrite =</span> T)
                <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;######## Model&quot;</span>, j, <span class="st">&quot;of&quot;</span>, jj, <span class="st">&quot;| Month&quot;</span>, k, <span class="st">&quot;of 12 | Year&quot;</span>, 
                  h, <span class="st">&quot;of&quot;</span>, <span class="kw">nlayers</span>(b.new.t), <span class="st">&quot;########&quot;</span>))
            }
            <span class="kw">rm</span>(b.new.t)
            <span class="kw">gc</span>()
            
            b.new.p &lt;-<span class="st"> </span><span class="kw">projectRaster</span>(b.anom.p, r.clim.p)
            <span class="kw">rm</span>(b.anom.p)
            <span class="kw">gc</span>()
            b.new.p &lt;-<span class="st"> </span><span class="kw">mask</span>(b.new.p, r.clim.p)
            <span class="kw">gc</span>()
            b.new.p &lt;-<span class="st"> </span><span class="kw">round</span>(b.new.p *<span class="st"> </span>r.clim.p)
            <span class="co"># assign(paste0(&#39;b.p.&#39;, k), b.new.p, pos=1) rm(b.new.p)</span>
            <span class="kw">gc</span>()
            <span class="kw">print</span>(<span class="st">&quot;Done with precipitation downscaling&quot;</span>)
            t.off &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()
            <span class="kw">print</span>(<span class="kw">difftime</span>(t.off, t.on))
            
            <span class="co"># b.new.p &lt;- get(paste0(&#39;b.p.&#39;, k), envir=.GlobalEnv)</span>
            for (h in <span class="dv">1</span>:<span class="kw">nlayers</span>(b.new.p)) {
                r.new.p &lt;-<span class="st"> </span><span class="kw">subset</span>(b.new.p, h)
                <span class="kw">names</span>(r.new.p) &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;pr_total_mm&quot;</span>, grp, models[j], scenario, 
                  mos[k], yrs[h], <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)
                if (isCRU) 
                  <span class="kw">names</span>(r.new.p) &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;CRU_CRU_&quot;</span>, <span class="st">&quot;CRU_&quot;</span>, <span class="kw">names</span>(r.new.p))
                <span class="kw">writeRaster</span>(r.new.p, <span class="kw">paste0</span>(outDir.p, <span class="st">&quot;/&quot;</span>, <span class="kw">names</span>(r.new.p), <span class="st">&quot;.tif&quot;</span>), 
                  <span class="dt">datatype =</span> <span class="st">&quot;FLT4S&quot;</span>, <span class="dt">options =</span> <span class="st">&quot;COMPRESS=LZW&quot;</span>, <span class="dt">overwrite =</span> T)
                <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;######## Model&quot;</span>, j, <span class="st">&quot;of&quot;</span>, jj, <span class="st">&quot;| Month&quot;</span>, k, <span class="st">&quot;of 12 | Year&quot;</span>, 
                  h, <span class="st">&quot;of&quot;</span>, <span class="kw">nlayers</span>(b.new.p), <span class="st">&quot;########&quot;</span>))
            }
            <span class="kw">rm</span>(b.new.p)
            <span class="kw">gc</span>()
        }
        
    }
    <span class="kw">return</span>()
}</code></pre>
</div>
<div id="run-downscaling" class="section level4">
<h4>Run downscaling</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Run</span>
if (<span class="kw">exists</span>(<span class="st">&quot;month.index&quot;</span>) &amp;&amp;<span class="st"> </span><span class="kw">all</span>(<span class="dv">1</span>:<span class="dv">12</span> %in%<span class="st"> </span>month.index)) {
    <span class="kw">mclapply</span>(month.index, f, <span class="dt">i =</span> i, <span class="dt">par.by.month =</span> <span class="ot">TRUE</span>, <span class="dt">anomDir =</span> anomDir, 
        <span class="dt">outDir =</span> outDir, <span class="dt">b.clim.t =</span> b.clim.t, <span class="dt">b.clim.p =</span> b.clim.p, <span class="dt">method =</span> <span class="st">&quot;akima&quot;</span>, 
        <span class="dt">mc.cores =</span> <span class="kw">length</span>(month.index))
} else <span class="kw">mclapply</span>(<span class="dv">1</span>:<span class="kw">length</span>(models), f, <span class="dt">i =</span> i, <span class="dt">anomDir =</span> anomDir, <span class="dt">outDir =</span> outDir, 
    <span class="dt">b.clim.t =</span> b.clim.t, <span class="dt">b.clim.p =</span> b.clim.p, <span class="dt">method =</span> <span class="st">&quot;akima&quot;</span>, <span class="dt">mc.cores =</span> <span class="kw">min</span>(<span class="kw">length</span>(models), 
        <span class="dv">32</span>))</code></pre>
</div>
</div>
</div>

<!-- some extra javascript for older browsers -->
<script type="text/javascript" src="libs/polyfill.js"></script>
<script>
  // manage active state of menu based on current page
  $(document).ready(function () {
  
    // active menu
    href = window.location.pathname
    href = href.substr(href.lastIndexOf('/') + 1)
    $('a[href="' + href + '"]').parent().addClass('active');
    
    // manage active menu header
    if (href.startsWith('authoring_'))
      $('a[href="' + 'authoring' + '"]').parent().addClass('active');
    else if (href.endsWith('_format.html'))
      $('a[href="' + 'formats' + '"]').parent().addClass('active');
    else if (href.startsWith('developer_'))
      $('a[href="' + 'developer' + '"]').parent().addClass('active');
	  
  });
</script>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>


</body>
</html>
